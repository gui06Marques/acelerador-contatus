<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acelerador de Contatos v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.47.1/build/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .humor-label, .accelerator-btn, .module-label, .product-label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .humor-label:hover, .accelerator-btn:hover, .module-label:hover, .product-label:hover {
            background-color: #374151; /* bg-gray-700 */
        }
        .accelerator-btn:hover {
             transform: translateY(-2px);
        }
        .humor-input:checked + .humor-label, .module-input:checked + .module-label, .product-input:checked + .product-label {
            background-color: #0e7490; /* bg-cyan-700 */
            border-color: #06b6d4; /* border-cyan-500 */
            color: white;
        }
        .speech-btn.listening, #assistant-mic-btn.listening {
            color: #ef4444; /* red-500 */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-6">
        
        <div class="text-center relative">
            <h1 class="text-3xl font-bold text-cyan-400">Acelerador de Contatos</h1>
            <p class="text-gray-400 mt-2">Preencha os dados e escolha um modo de registro.</p>
            <button id="toggle-assistant-mode-btn" class="absolute top-0 right-0 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15v1a1 1 0 001 1h12a1 1 0 001-1v-1a1 1 0 00-.293-.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>
                <span>Assistente de Voz</span>
            </button>
        </div>

        <!-- Voice Assistant UI -->
        <div id="assistant-section" class="hidden text-center p-8 border border-dashed border-gray-600 rounded-lg">
            <h2 id="assistant-message" class="text-2xl font-semibold text-cyan-300 mb-4">Olá! Vamos iniciar o registro.</h2>
            <p class="text-gray-400 mb-6">Clique no microfone para começar e responder às perguntas.</p>
            <div class="flex justify-center items-center space-x-6">
                <button id="assistant-mic-btn" class="text-gray-400 hover:text-white p-4 bg-gray-700 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.938V19a1 1 0 01-2 0v-4.062a8.001 8.001 0 01-4.472-1.588l-1.528 1.528A1 1 0 012 14.242V12.5A8.001 8.001 0 0112.5 4H14a1 1 0 01.707.293l1.528 1.528A8.001 8.001 0 0118 12.5v1.742a1 1 0 01-1.293.707l-1.528-1.528A8.001 8.001 0 0111 14.938z" clip-rule="evenodd" /></svg>
                </button>
            </div>
             <div class="mt-4 h-6">
                <p id="user-transcript" class="text-gray-500 italic"></p>
            </div>
        </div>

        <!-- INPUT FORM -->
        <div id="input-section" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="relative">
                    <label for="solicitante" class="block text-sm font-medium text-gray-300 mb-2">1. Solicitante</label>
                    <input type="text" id="solicitante" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="Nome do cliente">
                    <button class="speech-btn absolute right-3 top-9 text-gray-400 hover:text-white" data-target="solicitante">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.938V19a1 1 0 01-2 0v-4.062a8.001 8.001 0 01-4.472-1.588l-1.528 1.528A1 1 0 012 14.242V12.5A8.001 8.001 0 0112.5 4H14a1 1 0 01.707.293l1.528 1.528A8.001 8.001 0 0118 12.5v1.742a1 1 0 01-1.293.707l-1.528-1.528A8.001 8.001 0 0111 14.938z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div class="relative">
                    <label for="codigo-cliente" class="block text-sm font-medium text-gray-300 mb-2">2. Código do Cliente</label>
                    <input type="text" id="codigo-cliente" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="Ex: 5665">
                     <button class="speech-btn absolute right-3 top-9 text-gray-400 hover:text-white" data-target="codigo-cliente">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.938V19a1 1 0 01-2 0v-4.062a8.001 8.001 0 01-4.472-1.588l-1.528 1.528A1 1 0 012 14.242V12.5A8.001 8.001 0 0112.5 4H14a1 1 0 01.707.293l1.528 1.528A8.001 8.001 0 0118 12.5v1.742a1 1 0 01-1.293.707l-1.528-1.528A8.001 8.001 0 0111 14.938z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                    <label for="produto" class="block text-sm font-medium text-gray-300 mb-2">3. Produto</label>
                    <select id="produto" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></select>
                </div>
                <div>
                    <label for="origem" class="block text-sm font-medium text-gray-300 mb-2">4. Origem do Atendimento</label>
                    <select id="origem" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">5. Humor do Solicitante</label>
                <div id="humor-container" class="flex flex-wrap gap-2"></div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="situacao-principal" class="block text-sm font-medium text-gray-300 mb-2">6. Modo de Registro</label>
                    <select id="situacao-principal" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                        <option value="outro">Outro (Manual)</option>
                        <option value="acelerador">Acelerador (Modelos)</option>
                    </select>
                </div>
                <div>
                    <label for="dificuldade" class="block text-sm font-medium text-gray-300 mb-2">7. Grau de Dificuldade</label>
                    <select id="dificuldade" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></select>
                </div>
            </div>

            <!-- Conditional Fields -->
            <div id="campos-dinamicos" class="pt-4 border-t border-gray-700 space-y-4">
                
                 <!-- Modules Section (Clinicas Premium/MDO) -->
                <div id="modulos-premium-section" class="hidden">
                     <h3 class="text-lg font-semibold text-cyan-400 mb-3">Módulos (Clinicas Premium/MDO)</h3>
                     <div id="modulos-premium-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                </div>
                
                 <!-- Modules Section (Clinicas Basic) -->
                <div id="modulos-basic-section" class="hidden">
                     <h3 class="text-lg font-semibold text-cyan-400 mb-3">Módulos (Clinicas Basic)</h3>
                     <div id="modulos-basic-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                </div>

                 <!-- Modules Section (Clinicas Light/FlexPlus) -->
                <div id="modulos-light-section" class="hidden">
                     <h3 class="text-lg font-semibold text-cyan-400 mb-3">Módulos (Clinicas Light/FlexPlus)</h3>
                     <div id="modulos-light-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                </div>

                 <!-- Modules Section (LaudosUX) -->
                <div id="modulos-ux-section" class="hidden">
                     <h3 class="text-lg font-semibold text-cyan-400 mb-3">Módulos (Laudos UX)</h3>
                     <div id="modulos-ux-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                </div>

                <!-- Accelerator Buttons -->
                <div id="acelerador-buttons-section" class="hidden">
                     <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-cyan-400">Selecione um Acelerador:</h3>
                        <div class="flex items-center space-x-2">
                            <button id="edit-accelerator-btn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded-lg text-sm flex items-center space-x-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                <span>Editar</span>
                            </button>
                            <button id="delete-accelerator-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm flex items-center space-x-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                <span>Excluir</span>
                            </button>
                            <button id="show-add-accelerator-modal-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-1 px-3 rounded-lg text-sm flex items-center space-x-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                <span>Novo</span>
                            </button>
                        </div>
                     </div>
                     <div id="acelerador-buttons-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
                </div>

                <!-- Manual entry field -->
                <div id="descricao-section" class="relative">
                    <label for="descricao" class="block text-sm font-medium text-gray-300 mb-2">Descrição do Atendimento</label>
                    <textarea id="descricao" rows="6" class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-2 pr-10" placeholder="Descreva o problema e a solução. Use a palavra 'Solução:' para separar os dois."></textarea>
                     <button class="speech-btn absolute right-3 top-9 text-gray-400 hover:text-white" data-target="descricao">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.938V19a1 1 0 01-2 0v-4.062a8.001 8.001 0 01-4.472-1.588l-1.528 1.528A1 1 0 012 14.242V12.5A8.001 8.001 0 0112.5 4H14a1 1 0 01.707.293l1.528 1.528A8.001 8.001 0 0118 12.5v1.742a1 1 0 01-1.293.707l-1.528-1.528A8.001 8.001 0 0111 14.938z" clip-rule="evenodd" /></svg>
                    </button>
                </div>

                <!-- Template-based fields -->
                <div id="problema-solucao-section" class="hidden space-y-4">
                    <div class="relative">
                        <label for="problema" class="block text-sm font-medium text-gray-300 mb-2">Problema (editável)</label>
                        <textarea id="problema" rows="4" class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-2 pr-10"></textarea>
                         <button class="speech-btn absolute right-3 top-9 text-gray-400 hover:text-white" data-target="problema">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.938V19a1 1 0 01-2 0v-4.062a8.001 8.001 0 01-4.472-1.588l-1.528 1.528A1 1 0 012 14.242V12.5A8.001 8.001 0 0112.5 4H14a1 1 0 01.707.293l1.528 1.528A8.001 8.001 0 0118 12.5v1.742a1 1 0 01-1.293.707l-1.528-1.528A8.001 8.001 0 0111 14.938z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <div class="relative">
                        <label for="solucao" class="block text-sm font-medium text-gray-300 mb-2">Solução (editável)</label>
                        <textarea id="solucao" rows="4" class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-2 pr-10"></textarea>
                         <button class="speech-btn absolute right-3 top-9 text-gray-400 hover:text-white" data-target="solucao">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.938V19a1 1 0 01-2 0v-4.062a8.001 8.001 0 01-4.472-1.588l-1.528 1.528A1 1 0 012 14.242V12.5A8.001 8.001 0 0112.5 4H14a1 1 0 01.707.293l1.528 1.528A8.001 8.001 0 0118 12.5v1.742a1 1 0 01-1.293.707l-1.528-1.528A8.001 8.001 0 0111 14.938z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>

                <!-- Demand Generation Form -->
                 <div id="demand-form-section" class="hidden mt-6 pt-6 border-t-2 border-dashed border-cyan-500">
                     <h2 class="text-2xl font-bold text-cyan-400 mb-4 text-center">Formulário de Nova Demanda</h2>
                     <div class="space-y-4">
                        <div>
                            <label for="demand-solicitacao" class="block text-sm font-medium text-gray-300 mb-1">Solicitação</label>
                            <textarea id="demand-solicitacao" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="demand-nome-clinica" class="block text-sm font-medium text-gray-300 mb-1">Nome Clínica</label>
                                <input type="text" id="demand-nome-clinica" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2">
                            </div>
                             <div>
                                <label for="demand-telefone" class="block text-sm font-medium text-gray-300 mb-1">Telefone</label>
                                <input type="tel" id="demand-telefone" placeholder="(xx) xxxxx-xxxx" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label for="demand-nome-solicitante" class="block text-sm font-medium text-gray-300 mb-1">Nome Solicitante</label>
                                <input type="text" id="demand-nome-solicitante" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2">
                            </div>
                            <div>
                               <label for="demand-email" class="block text-sm font-medium text-gray-300 mb-1">E-mail</label>
                               <input type="email" id="demand-email" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2">
                           </div>
                        </div>
                     </div>
                     <div class="mt-6 bg-gray-700/50 p-4 rounded-lg">
                        <label for="template-file" class="block text-lg font-bold text-gray-300 mb-2">1. Carregue o Modelo Word (.docx)</label>
                        <input type="file" id="template-file" accept=".docx" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-cyan-100 file:text-cyan-800 hover:file:bg-cyan-200 mt-2">
                    </div>
                     <div class="mt-6">
                        <label for="attachment" class="block text-sm font-medium text-gray-300 mb-1">2. Anexar Arquivo (para o e-mail)</label>
                        <input type="file" id="attachment" accept="image/*,.pdf" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-gray-200 hover:file:bg-gray-500">
                    </div>
                    <div class="mt-8 flex justify-end space-x-4">
                        <button type="button" id="generate-demand-doc-btn" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">Gerar Documento</button>
                        <button type="button" id="prepare-email-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Preparar E-mail</button>
                    </div>
                 </div>

            </div>

            <div class="flex justify-center flex-wrap gap-4 pt-4">
                <button id="generate-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Registrar e Gerar Contatos</span>
                </button>
            </div>
        </div>

        <!-- OUTPUT SECTION (COMPANY STANDARD TEXT) -->
        <div id="text-output-section" class="hidden pt-6 border-t border-gray-700">
            <h2 class="text-xl font-semibold text-center text-cyan-400 mb-4">Contato Final (Padrão Empresa)</h2>
            <div class="bg-gray-900 rounded-lg p-4 relative">
                <textarea id="text-output" rows="15" class="w-full bg-gray-900 text-gray-300 border-none focus:ring-0 text-sm font-mono" readonly></textarea>
                <button id="copy-text-btn" class="absolute top-3 right-3 bg-gray-600 hover:bg-gray-500 text-white p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                </button>
            </div>
        </div>
        
        <!-- OUTPUT SECTION (JSON) -->
        <div id="json-output-section" class="hidden pt-6 border-t border-gray-700">
            <h2 class="text-xl font-semibold text-center text-cyan-400 mb-4">Resultado Estruturado (JSON)</h2>
            <div class="bg-gray-900 rounded-lg p-4 relative">
                <pre><code id="json-output" class="language-json text-sm whitespace-pre-wrap break-all"></code></pre>
                <button id="copy-json-btn" class="absolute top-3 right-3 bg-gray-600 hover:bg-gray-500 text-white p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                </button>
            </div>
        </div>

        <!-- Login Modal -->
        <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm space-y-4">
                 <h2 class="text-xl font-bold text-cyan-400">Acesso Restrito</h2>
                 <div>
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Usuário</label>
                    <input type="text" id="username" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                 </div>
                 <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                 </div>
                 <p id="login-error" class="text-red-500 text-sm hidden">Usuário ou senha inválidos.</p>
                 <div class="flex justify-end space-x-3">
                    <button id="cancel-login-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button id="login-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Entrar</button>
                </div>
            </div>
        </div>

        <!-- Add Accelerator Modal -->
        <div id="add-accelerator-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg space-y-4">
                <h2 id="modal-title" class="text-xl font-bold text-cyan-400">Cadastrar Novo Acelerador</h2>
                <div>
                    <label for="new-accelerator-name" class="block text-sm font-medium text-gray-300 mb-1">Nome do Acelerador</label>
                    <input type="text" id="new-accelerator-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="Ex: Correção de Nota Fiscal">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Associar aos Produtos</label>
                    <div id="new-accelerator-products-container" class="max-h-40 overflow-y-auto bg-gray-700 p-2 rounded-lg grid grid-cols-2 gap-2">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                </div>
                <div>
                    <label for="new-accelerator-problem" class="block text-sm font-medium text-gray-300 mb-1">Descrição do Problema</label>
                    <textarea id="new-accelerator-problem" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2"></textarea>
                </div>
                <div>
                    <label for="new-accelerator-solution" class="block text-sm font-medium text-gray-300 mb-1">Descrição da Solução</label>
                    <textarea id="new-accelerator-solution" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-add-accelerator-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button id="save-accelerator-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DATA ---
        const humorOptions = ['Agradecido', 'Atencioso', 'Nervoso', 'Impaciente', 'Indiferente', 'Insatisfeito'];
        const dificuldadeOptions = ['Muito fácil', 'Fácil', 'Moderado', 'Difícil', 'Muito difícil'];
        const produtos = ['Laudos4.x', 'LaudosFlex', 'ClinicasMDO', 'ClinicasLight-FlexPlus', 'ClinicasBasic', 'ClinicasPremium', 'LaudosUX', 'Paciente Conectado', 'MedwareWebAPI', 'Meus Exames Web', 'DICOM', 'AppMeusExames', 'AppAgenda', 'Image', 'OutrosProgramas'];
        const origemOptions = ['Telefone', 'WhatsApp', 'Email', 'Transferência de outro setor'];
        
        const phoneticMap = {
            'LaudosUX': ['laudosux', 'laudosuexis', 'laudosis', 'laudos x'],
            'DICOM': ['dicom', 'daycom', 'daicom'],
            'Laudos4.x': ['laudos4', 'laudos 4x', 'laudos 4'],
            'LaudosFlex': ['laudosflex', 'laudos flex'],
            'Meus Exames Web': ['meus exames web', 'meus exames'],
        };

        const fullModuleList = {
            '#MODULO_ADMIN': 'Admin', '#MODULO_AGENDA': 'Agenda', '#MODULO_AGENDAMENTOWEB': 'Agenda Web', '#MODULO_APICLINICAS': 'API Clinicas', '#MODULO_APPAGENDA': 'App Agenda', '#MODULO_BACKUPCLINICAS': 'Backup', '#MODULO_BAIXADEFATURA': 'Baixa Fatura', '#MODULO_BIBLIOTECAS': 'Bibliotecas', '#MODULO_CAIXA': 'Caixa', '#MODULO_CONTAS': 'Contas', '#MODULO_CONTATUS': 'Contatus', '#MODULO_DICOM': 'Dicom', '#MODULO_DRE': 'DRE', '#MODULO_ESTOQUE': 'Estoque', '#MODULO_ETIQUETA': 'Etiqueta', '#MODULO_FATURAMENTO': 'Faturamento', '#MODULO_INTEGRAÇÃO': 'Integração', '#MODULO_INTERNO': 'Interno', '#MODULO_LAUDOS': 'Laudos', '#MODULO_LAUDOSFLEX': 'Laudos Flex', '#MODULO_LAUDOSUX': 'Laudos UX', '#MODULO_LEADS': 'Leads', '#MODULO_MEDWARECLINICAS': 'Medware', '#MODULO_MEUSEXAMESAPP': 'App Meus Exames', '#MODULO_MEUSEXAMESWEB': 'Web Meus Exames', '#MODULO_NFE': 'NFE', '#MODULO_NFE_INTERNA': 'NFE Interna', '#MODULO_ORIENTAÇÕESDEATENDIMENTO': 'Orientações', '#MODULO_PACIENTECONECTADO': 'Paciente Conectado', '#MODULO_PAGAMENTOMÉDICO': 'Pag. Médico', '#MODULO_POWERBI': 'PowerBI', '#MODULO_RECURSODEGLOSA': 'Recurso Glosa', '#MODULO_RELATÓRIOS': 'Relatórios', '#MODULO_RELÓGIOEFOLHADEPONTO': 'Ponto', '#MODULO_SENHA': 'Senha', '#MODULO_TASKBAR': 'Taskbar', '#MODULO_TELÃO': 'Telão'
        };

        const modulosUX = {
            '#MODULO_AGENDA': 'Agenda', '#MODULO_AGENDAMENTOWEB': 'Agenda Web', '#MODULO_APIUX': 'API UX', '#MODULO_APPAGENDA': 'App Agenda', '#MODULO_BIBLIOTECAS': 'Bibliotecas', '#MODULO_DICOM': 'Dicom', '#MODULO_INTEGRAÇÃO': 'Integração', '#MODULO_LAUDOSUX': 'Laudos UX', '#MODULO_MEUSEXAMESWEB': 'Web Meus Exames', '#MODULO_NFE': 'NFE', '#MODULO_PACIENTECONECTADO': 'Paciente Conectado', '#MODULO_RELATÓRIOS': 'Relatórios', '#MODULO_SENHA': 'Senha', '#MODULO_TELÃO': 'Telão'
        };

        function filterModules(original, toRemove) {
            const copy = { ...original };
            toRemove.forEach(key => delete copy[key]);
            return copy;
        }

        const modulosClinicasPremium = filterModules(fullModuleList, ['#MODULO_ADMIN', '#MODULO_INTERNO', '#MODULO_LEADS', '#MODULO_MEDWARECLINICAS']);
        const modulosClinicasBasic = filterModules(modulosClinicasPremium, ['#MODULO_CONTAS', '#MODULO_ESTOQUE']);
        const modulosClinicasLight = filterModules(modulosClinicasPremium, ['#MODULO_CONTAS', '#MODULO_ESTOQUE', '#MODULO_BAIXADEFATURA', '#MODULO_FATURAMENTO', '#MODULO_CAIXA', '#MODULO_NFE', '#MODULO_PAGAMENTOMÉDICO', '#MODULO_NFE_INTERNA']);

        let situacaoTemplates = {
            'instalacao_sistema': { nome: 'Instalação do Sistema', problema: 'Cliente solicitou a instalação do sistema em uma nova estação de trabalho.', solucao: 'Acesso remoto estabelecido na estação de trabalho. Realizada a instalação e a subsequente atualização do sistema para a versão mais recente.', associatedProducts: ['clinicas', 'LaudosFlex'] },
            'troca_servidor': { nome: 'Troca de Servidor', problema: 'Cliente solicitou suporte para realizar a migração do sistema para um novo servidor.', solucao: 'Acesso solicitado aos servidores de origem e destino. O serviço do sistema foi interrompido, e a aplicação foi instalada e configurada no novo servidor, com a subsequente reconfiguração das estações de trabalho.', associatedProducts: ['all'] },
            'habilitação_sistema': { nome: 'Habilitação do Sistema', problema: 'Cliente solicitou a habilitação da licença do sistema.', solucao: 'Licença do sistema habilitada com sucesso.', associatedProducts: ['all'] },
            'desbloqueio_usuario': { nome: 'Desbloqueio de Usuário', problema: 'Cliente solicitou o desbloqueio de um usuário de acesso ao sistema.', solucao: 'Usuário do sistema desbloqueado com sucesso.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'alteracao_senha': { nome: 'Alteração de Senha', problema: 'Cliente solicitou alteração de senha de usuário.', solucao: 'A senha do usuário foi alterada no sistema conforme solicitado.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'atualizacao_sistema': { nome: 'Atualização do Sistema', problema: 'Cliente solicitou a atualização do sistema para a versão mais recente.', solucao: 'Procedimento de atualização do sistema realizado com sucesso no servidor e/ou estações.', associatedProducts: ['clinicas', 'LaudosFlex'] },
            'sistema_nao_abre': { nome: 'Sistema não abre', problema: 'Usuário reportou que o sistema não inicia na estação de trabalho.', solucao: 'Diagnóstico identificou falha de acesso devido à ausência de credenciais de rede salvas e/ou nome do servidor incorreto no arquivo de configuração (bd.xml). Após a correção, o acesso foi normalizado.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'prontuario_nao_abre': { nome: 'Prontuário não abre', problema: 'Usuário reportou que não consegue abrir o prontuário do paciente.', solucao: 'Diagnóstico identificou falha de acesso devido à ausência de credenciais de rede salvas e/ou nome do servidor incorreto no arquivo de configuração (bd.xml). Após a correção, o acesso ao prontuário foi normalizado.', associatedProducts: ['clinicas', 'LaudosFlex'] },
            'configuracao_dicom': { nome: 'Configuração Dicom', problema: 'Cliente solicitou ajuste nas configurações do Dicom.', solucao: 'Realizado acesso remoto à estação com o software Dicom. As configurações foram ajustadas de acordo com as especificações do cliente, seguido de testes e validação da funcionalidade.', associatedProducts: ['DICOM'] },
            'dicom_nao_envia': { nome: 'Dicom não envia', problema: 'Cliente reportou que as imagens de um equipamento não estão sendo enviadas via Dicom.', solucao: 'Com base na análise das informações do equipamento (modalidade), as configurações de comunicação foram ajustadas tanto no aparelho quanto no software Dicom para restabelecer a transmissão de imagens.', associatedProducts: ['DICOM'] },
            'exames_nao_enviam': { nome: 'Exames não enviam', problema: 'Cliente reportou que os exames laudados não estão sendo enviados para o portal web.', solucao: 'Identificado que o serviço responsável pela transmissão de exames estava inativo no servidor. O serviço foi reiniciado e o envio de exames foi normalizado.', associatedProducts: ['Meus Exames Web'] },
            'apagar_exame_site': { nome: 'Apagar Exame (Site)', problema: 'Cliente solicitou a remoção completa de um exame do portal de resultados.', solucao: 'Realizado acesso remoto ao servidor. O procedimento de exclusão de exame foi executado, envolvendo a remoção dos arquivos PDF da pasta do sistema e a desvinculação dos respectivos registros no portal.', associatedProducts: ['Meus Exames Web'] },
            'pdf_nao_associa': { nome: 'PDF não associa', problema: 'Usuário informou que o arquivo PDF do laudo não está sendo associado ao cadastro do exame.', solucao: 'Diagnóstico identificou que a estação não possuía as credenciais de rede para acessar a pasta compartilhada de laudos. Após o mapeamento de rede, a associação de arquivos PDF foi normalizada.', associatedProducts: ['clinicas', 'LaudosFlex'] },
            'impressao_em_branco': { nome: 'Impressão em Branco', problema: 'Cliente reportou que as impressões do sistema estão saindo em branco ou não são geradas.', solucao: 'O problema de impressão foi solucionado realizando um procedimento de reinstalação do sistema e de seus componentes de relatório.', associatedProducts: ['clinicas', 'LaudosFlex'] },
            'edicao_guia_bloqueada': { nome: 'Edição de Guia', problema: 'Cliente reportou que não consegue editar uma guia de atendimento.', solucao: 'Análise identificou que a guia possuía vínculos (recebimento, nota fiscal, pagamento médico) que impediam a edição. Após a remoção dos vínculos, a edição da guia foi liberada e validada com o cliente.', associatedProducts: ['ClinicasBasic', 'ClinicasPremium'] },
            'alterar_recebimento_caixa': { nome: 'Alterar Recebimento', problema: 'Cliente solicitou alteração em um recebimento de guia já registrado no caixa.', solucao: 'O recebimento foi localizado através do número do caixa e da guia. A alteração foi efetuada no sistema após a devida autorização por senha.', associatedProducts: ['ClinicasBasic', 'ClinicasPremium'] },
            'ajuste_honorario_medico': { nome: 'Ajuste Honorário', problema: 'O pagamento médico não está sendo calculado corretamente.', solucao: 'Identificado que a configuração de honorários no cadastro do médico estava incorreta. Após a reconfiguração dos valores, o cálculo do pagamento foi ajustado.', associatedProducts: ['ClinicasBasic', 'ClinicasPremium'] },
            'orientacao_cad_medico': { nome: 'Orientação: Cad. Médico', problema: 'Cliente solicitou orientação para realizar o cadastro de novos médicos.', solucao: 'Através de acesso remoto, foi demonstrado o processo de cadastro de profissionais no módulo "Bibliotecas > Manutenção de Médicos", realizando o cadastro de um médico como exemplo.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'orientacao_cad_agenda': { nome: 'Orientação: Cad. Agenda', problema: 'Cliente solicitou orientação para realizar o cadastro de novas agendas.', solucao: 'Através de acesso remoto, foi demonstrado o processo de cadastro de agendas no módulo "Agendamento", realizando um registro como exemplo.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'orientacao_cad_procedimento': { nome: 'Orientação: Cad. Procedimento', problema: 'Cliente solicitou orientação para realizar o cadastro de procedimentos.', solucao: 'Através de acesso remoto, foi demonstrado o processo de cadastro no módulo "Bibliotecas > Procedimentos", realizando um registro como exemplo.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'orientacao_cad_operadora': { nome: 'Orientação: Cad. Operadora', problema: 'Cliente solicitou orientação para realizar o cadastro de operadoras/convênios.', solucao: 'Através de acesso remoto, foi demonstrado o processo de cadastro no módulo "Bibliotecas > Operadoras", realizando um registro como exemplo.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'orientacao_cad_usuario': { nome: 'Orientação: Cad. Usuário', problema: 'Cliente solicitou orientação para realizar o cadastro de usuários.', solucao: 'Através de acesso remoto, foi demonstrado o processo de cadastro no módulo "Bibliotecas > Manutenção de Usuários", realizando um registro como exemplo.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'orientacao_cad_med_ag_user': { nome: 'Orientação: Cad. Múltiplos', problema: 'Cliente solicitou orientação sobre os cadastros de Médico, Agenda e Usuário.', solucao: 'Através de acesso remoto, foram demonstrados os processos de cadastro nos respectivos módulos do sistema, sanando as dúvidas do cliente.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'permissoes_usuario': { nome: 'Permissões de Usuário', problema: 'Cliente solicitou a alteração ou concessão de permissões para um usuário.', solucao: 'Acesso remoto estabelecido. No módulo "Bibliotecas > Manutenção de Usuários", foram ajustados os privilégios de acesso ao usuário, conforme especificado.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'config_assinatura_scan': { nome: 'Config. Assinatura (Scan)', problema: 'Cliente solicitou a configuração da assinatura escaneada de um médico nos laudos.', solucao: 'A imagem da assinatura digitalizada do médico foi vinculada ao seu respectivo cadastro no sistema.', associatedProducts: ['clinicas', 'LaudosFlex'] },
            'config_assinatura_digital': { nome: 'Config. Assinatura (Digital)', problema: 'Cliente solicitou a configuração do certificado digital do médico para assinatura de laudos.', solucao: 'Realizada a instalação do certificado digital (token/cartão) na estação de trabalho e sua posterior configuração no cadastro do médico para permitir a assinatura digital de documentos.', associatedProducts: ['clinicas', 'LaudosFlex'] },
            'adicionar_configurar_laudo': { nome: 'Adicionar/Config. Laudo', problema: 'Cliente solicitou suporte para adicionar ou configurar um novo modelo de laudo.', solucao: 'Acesso remoto realizado para configurar o novo modelo de laudo no sistema, incluindo a definição de máscaras, campos e formatação, conforme especificado pelo cliente.', associatedProducts: ['clinicas', 'LaudosFlex', 'LaudosUX'] },
            'solicitacao_demanda': { nome: 'Solicitação de Demanda', problema: 'Cliente solicitou uma nova funcionalidade ou um ajuste específico no sistema.', solucao: 'Requisitos da solicitação foram levantados e a demanda foi registrada para análise e desenvolvimento pela equipe de produto.', associatedProducts: ['all'] }
        };

        // --- DOM Element References ---
        let solicitanteInput, codigoClienteInput, produtoSelect, origemSelect, humorContainer, situacaoPrincipalSelect, dificuldadeSelect, problemaTextarea, solucaoTextarea, descricaoTextarea, problemaSolucaoSection, descricaoSection, aceleradorButtonsSection, aceleradorButtonsContainer, modulosPremiumSection, modulosPremiumContainer, modulosBasicSection, modulosBasicContainer, modulosLightSection, modulosLightContainer, modulosUxSection, modulosUxContainer, generateBtn, jsonOutputSection, textOutputSection, jsonOutput, textOutput, copyJsonBtn, copyTextBtn, addAcceleratorModal, showAddAcceleratorModalBtn, cancelAddAcceleratorBtn, saveAcceleratorBtn, newAcceleratorName, newAcceleratorProductsContainer, newAcceleratorProblem, newAcceleratorSolution, modalTitle, editAcceleratorBtn, deleteAcceleratorBtn, loginModal, cancelLoginBtn, loginBtn, usernameInput, passwordInput, loginError, toggleAssistantBtn, assistantSection, assistantMicBtn, assistantMessage, userTranscript, demandFormSection, generateDemandDocBtn, prepareEmailBtn;

        function assignDomElements() {
            solicitanteInput = document.getElementById('solicitante');
            codigoClienteInput = document.getElementById('codigo-cliente');
            produtoSelect = document.getElementById('produto');
            origemSelect = document.getElementById('origem');
            humorContainer = document.getElementById('humor-container');
            situacaoPrincipalSelect = document.getElementById('situacao-principal');
            dificuldadeSelect = document.getElementById('dificuldade');
            problemaTextarea = document.getElementById('problema');
            solucaoTextarea = document.getElementById('solucao');
            descricaoTextarea = document.getElementById('descricao');
            problemaSolucaoSection = document.getElementById('problema-solucao-section');
            descricaoSection = document.getElementById('descricao-section');
            aceleradorButtonsSection = document.getElementById('acelerador-buttons-section');
            aceleradorButtonsContainer = document.getElementById('acelerador-buttons-container');
            modulosPremiumSection = document.getElementById('modulos-premium-section');
            modulosPremiumContainer = document.getElementById('modulos-premium-container');
            modulosBasicSection = document.getElementById('modulos-basic-section');
            modulosBasicContainer = document.getElementById('modulos-basic-container');
            modulosLightSection = document.getElementById('modulos-light-section');
            modulosLightContainer = document.getElementById('modulos-light-container');
            modulosUxSection = document.getElementById('modulos-ux-section');
            modulosUxContainer = document.getElementById('modulos-ux-container');
            generateBtn = document.getElementById('generate-btn');
            jsonOutputSection = document.getElementById('json-output-section');
            textOutputSection = document.getElementById('text-output-section');
            jsonOutput = document.getElementById('json-output');
            textOutput = document.getElementById('text-output');
            copyJsonBtn = document.getElementById('copy-json-btn');
            copyTextBtn = document.getElementById('copy-text-btn');
            addAcceleratorModal = document.getElementById('add-accelerator-modal');
            showAddAcceleratorModalBtn = document.getElementById('show-add-accelerator-modal-btn');
            cancelAddAcceleratorBtn = document.getElementById('cancel-add-accelerator-btn');
            saveAcceleratorBtn = document.getElementById('save-accelerator-btn');
            newAcceleratorName = document.getElementById('new-accelerator-name');
            newAcceleratorProductsContainer = document.getElementById('new-accelerator-products-container');
            newAcceleratorProblem = document.getElementById('new-accelerator-problem');
            newAcceleratorSolution = document.getElementById('new-accelerator-solution');
            modalTitle = document.getElementById('modal-title');
            editAcceleratorBtn = document.getElementById('edit-accelerator-btn');
            deleteAcceleratorBtn = document.getElementById('delete-accelerator-btn');
            loginModal = document.getElementById('login-modal');
            cancelLoginBtn = document.getElementById('cancel-login-btn');
            loginBtn = document.getElementById('login-btn');
            usernameInput = document.getElementById('username');
            passwordInput = document.getElementById('password');
            loginError = document.getElementById('login-error');
            toggleAssistantBtn = document.getElementById('toggle-assistant-mode-btn');
            assistantSection = document.getElementById('assistant-section');
            assistantMicBtn = document.getElementById('assistant-mic-btn');
            assistantMessage = document.getElementById('assistant-message');
            userTranscript = document.getElementById('user-transcript');
            demandFormSection = document.getElementById('demand-form-section');
            generateDemandDocBtn = document.getElementById('generate-demand-doc-btn');
            prepareEmailBtn = document.getElementById('prepare-email-btn');
        }

        let activeAcceleratorKey = '';
        let recognition;
        let activeSpeechTarget = null;
        let pendingAdminAction = null;
        let assistantConversation;
        let isRecognitionRunning = false;
        let demandTemplateFile = null;

        // --- Core Functions ---
        function initializeForm() {
            assignDomElements();
            humorContainer.innerHTML = humorOptions.map(h => `<div><input type="checkbox" id="humor-${h}" value="${h}" class="hidden humor-input"><label for="humor-${h}" class="humor-label block border-2 border-gray-600 rounded-full px-4 py-1 text-sm">${h}</label></div>`).join('');
            dificuldadeSelect.innerHTML = dificuldadeOptions.map(d => `<option value="${d}">${d}</option>`).join('');
            produtoSelect.innerHTML = produtos.map(p => `<option value="${p}">${p}</option>`).join('');
            origemSelect.innerHTML = origemOptions.map(o => `<option value="${o}">${o}</option>`).join('');
            dificuldadeSelect.value = 'Fácil';
            
            const createModuleCheckboxes = (moduleList, container) => {
                 container.innerHTML = Object.keys(moduleList).map(key => `
                    <div>
                        <input type="checkbox" id="module-${container.id}-${key}" value="${key}" class="hidden module-input">
                        <label for="module-${container.id}-${key}" class="module-label block border-2 border-gray-600 rounded-lg px-2 py-1 text-xs text-center">${moduleList[key]}</label>
                    </div>
                `).join('');
            };

            createModuleCheckboxes(modulosClinicasPremium, modulosPremiumContainer);
            createModuleCheckboxes(modulosClinicasBasic, modulosBasicContainer);
            createModuleCheckboxes(modulosClinicasLight, modulosLightContainer);
            createModuleCheckboxes(modulosUX, modulosUxContainer);
            
            const productOptions = ['all', 'clinicas', 'laudosflex', 'laudosux', ...produtos];
            newAcceleratorProductsContainer.innerHTML = productOptions.map(p => `
                <div>
                    <input type="checkbox" id="product-assoc-${p}" value="${p}" class="hidden product-input">
                    <label for="product-assoc-${p}" class="product-label block border-2 border-gray-600 rounded-lg px-3 py-1 text-sm">${p}</label>
                </div>
            `).join('');

            initializeSpeechRecognition();
            addEventListeners();
            updateFormDisplay();
            updateModulesVisibility();
            loadCustomAccelerators();
            renderAcceleratorButtons();
        }

        function renderAcceleratorButtons() {
            const selectedProduct = produtoSelect.value;
            const filteredTemplates = Object.keys(situacaoTemplates).filter(key => {
                const template = situacaoTemplates[key];
                if (!template) return false;
                const associations = template.associatedProducts || [];
                if (associations.includes('all')) return true;
                if (associations.includes(selectedProduct)) return true;
                if (associations.includes('clinicas') && selectedProduct.toLowerCase().startsWith('clinicas')) return true;
                if (associations.includes('laudosflex') && selectedProduct === 'LaudosFlex') return true;
                if (associations.includes('laudosux') && selectedProduct === 'LaudosUX') return true;
                return false;
            });

            aceleradorButtonsContainer.innerHTML = filteredTemplates.map(key => 
                `<button data-key="${key}" class="accelerator-btn text-left w-full bg-gray-700/50 p-2 rounded-lg text-sm">${situacaoTemplates[key].nome}</button>`
            ).join('');
        }

        function loadCustomAccelerators() {
            const customAccelerators = JSON.parse(localStorage.getItem('customAccelerators') || '{}');
            situacaoTemplates = { ...situacaoTemplates, ...customAccelerators };
        }

        function saveCustomAccelerator(key, name, problem, solution, associatedProducts) {
            const customAccelerators = JSON.parse(localStorage.getItem('customAccelerators') || '{}');
            customAccelerators[key] = { nome: name, problema, solucao, associatedProducts };
            localStorage.setItem('customAccelerators', JSON.stringify(customAccelerators));
            situacaoTemplates[key] = { nome: name, problema, solucao, associatedProducts };
        }

        function deleteCustomAccelerator(key) {
             const customAccelerators = JSON.parse(localStorage.getItem('customAccelerators') || '{}');
             delete customAccelerators[key];
             localStorage.setItem('customAccelerators', JSON.stringify(customAccelerators));
             delete situacaoTemplates[key];
        }

        function updateModulesVisibility() {
            const selectedProduct = produtoSelect.value;
            modulosPremiumSection.classList.add('hidden');
            modulosBasicSection.classList.add('hidden');
            modulosLightSection.classList.add('hidden');
            modulosUxSection.classList.add('hidden');

            if (selectedProduct === 'ClinicasBasic') {
                modulosBasicSection.classList.remove('hidden');
            } else if (selectedProduct === 'ClinicasLight-FlexPlus') {
                modulosLightSection.classList.remove('hidden');
            } else if (selectedProduct === 'LaudosUX') {
                modulosUxSection.classList.remove('hidden');
            } else if (selectedProduct.toLowerCase().startsWith('clinicas')) { // Catches Premium and MDO
                modulosPremiumSection.classList.remove('hidden');
            }
        }

        function updateFormDisplay() {
            const selectedMode = situacaoPrincipalSelect.value;
            problemaSolucaoSection.classList.add('hidden');
            editAcceleratorBtn.classList.add('hidden');
            deleteAcceleratorBtn.classList.add('hidden');
            demandFormSection.classList.add('hidden');
            
            if (selectedMode === 'outro') {
                aceleradorButtonsSection.classList.add('hidden');
                descricaoSection.classList.remove('hidden');
                activeAcceleratorKey = '';
            } else { // 'acelerador'
                descricaoSection.classList.add('hidden');
                aceleradorButtonsSection.classList.remove('hidden');
                renderAcceleratorButtons();
            }
        }
        
        function handleAcceleratorClick(key) {
            activeAcceleratorKey = key;
            const template = situacaoTemplates[key];
            problemaTextarea.value = template.problema || '';
            solucaoTextarea.value = template.solucao || '';
            problemaSolucaoSection.classList.remove('hidden');
            
            editAcceleratorBtn.classList.remove('hidden');
            deleteAcceleratorBtn.classList.remove('hidden');
            
            if (key.startsWith('custom_')) {
                deleteAcceleratorBtn.disabled = false;
            } else {
                deleteAcceleratorBtn.disabled = true;
            }

            if (key === 'solicitacao_demanda') {
                demandFormSection.classList.remove('hidden');
                document.getElementById('demand-nome-solicitante').value = solicitanteInput.value;
                document.getElementById('demand-nome-clinica').value = ''; // Reset for manual input
                document.getElementById('demand-telefone').value = '';
                document.getElementById('demand-email').value = '';
                document.getElementById('demand-solicitacao').value = problemaTextarea.value;
            } else {
                demandFormSection.classList.add('hidden');
            }
        }

        function generateProtocol() {
            const clientCode = codigoClienteInput.value.trim();
            if (!clientCode) {
                alert('Por favor, insira o Código do Cliente.');
                return null;
            }
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            
            return `${clientCode}${year}${month}${day}${hours}`;
        }

        function getProblemAndSolution() {
            let problema = '';
            let solucao = '';
            const selectedMode = situacaoPrincipalSelect.value;

            if (selectedMode === 'outro') {
                const descText = descricaoTextarea.value;
                const solutionKeywords = ['solução:', 'solucao:', 'resolvido com', 'foi feito', 'realizado o procedimento', 'a solução foi', 'procedimento realizado'];
                let splitIndex = -1;
                let keywordFound = '';

                for(const keyword of solutionKeywords) {
                    const index = descText.toLowerCase().indexOf(keyword);
                    if (index !== -1) {
                        splitIndex = index;
                        keywordFound = keyword;
                        break;
                    }
                }

                if (splitIndex !== -1) {
                    problema = descText.substring(0, splitIndex).trim();
                    solucao = descText.substring(splitIndex + keywordFound.length).trim();
                } else {
                    problema = descText;
                    solucao = 'Não especificada.';
                }
            } else {
                problema = problemaTextarea.value;
                solucao = solucaoTextarea.value;
            }
            return { problema, solucao };
        }

        function getSelectedModuleTags() {
            if (!modulosPremiumSection.classList.contains('hidden')) {
                return Array.from(modulosPremiumContainer.querySelectorAll('input:checked')).map(input => input.value);
            }
            if (!modulosBasicSection.classList.contains('hidden')) {
                return Array.from(modulosBasicContainer.querySelectorAll('input:checked')).map(input => input.value);
            }
            if (!modulosLightSection.classList.contains('hidden')) {
                return Array.from(modulosLightContainer.querySelectorAll('input:checked')).map(input => input.value);
            }
            if (!modulosUxSection.classList.contains('hidden')) {
                return Array.from(modulosUxContainer.querySelectorAll('input:checked')).map(input => input.value);
            }
            return [];
        }

        function generateFinalText(protocol) {
            const { problema, solucao } = getProblemAndSolution();
            const data = new Date();
            const dataFormatada = data.toLocaleDateString('pt-BR');
            const solicitante = solicitanteInput.value || 'Não informado';
            const dificuldade = dificuldadeSelect.value;
            
            const productTag = `#${produtoSelect.value.replace(/\s+/g, '')}`;
            const origemTag = `#${origemSelect.value.replace(/\s+/g, '')}`;
            const moduleTags = getSelectedModuleTags();
            const humorTags = Array.from(humorContainer.querySelectorAll('input:checked')).map(input => `#${input.value.replace(/\s+/g, '')}`);
            const situacaoKey = activeAcceleratorKey || 'Outros';
            const allTags = [
                productTag,
                origemTag,
                `#${situacaoKey.replace(/_/g, '')}`,
                ...humorTags,
                `#${dificuldade.replace(/\s+/g, '')}`,
                ...moduleTags
            ].join('');

            return `<protocolo>${protocol}</protocolo>\n\n<data>${dataFormatada}</data>\n\n<problema>${problema}</problema>\n\n<solucao>${solucao}</solucao>\n\n<solicitante>${solicitante}</solicitante>\n\n<dificuldade>${dificuldade}</dificuldade>\n\n-------------------------------------------------------\nTags: ${allTags}`;
        }

        function generateFinalJson(protocol) {
            const { problema, solucao } = getProblemAndSolution();
            const selectedHumor = Array.from(humorContainer.querySelectorAll('input:checked')).map(input => input.value);
            const selectedModules = getSelectedModuleTags();
            const situacaoKey = activeAcceleratorKey || 'outro';
            
            return {
                protocolo: protocol,
                codigo_cliente: codigoClienteInput.value.trim(),
                data_hora: new Date().toISOString(),
                solicitante: {
                    nome: solicitanteInput.value || 'Não informado',
                    humor: selectedHumor,
                },
                produto: {
                    nome: produtoSelect.value,
                    modulos: selectedModules
                },
                atendimento: {
                    origem: origemSelect.value,
                    situacao: situacaoTemplates[situacaoKey]?.nome || 'Manual',
                    dificuldade: dificuldadeSelect.value,
                    problema: problema,
                    solucao: solucao
                }
            };
        }

        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Speech Recognition not supported in this browser.");
                document.querySelectorAll('.speech-btn').forEach(btn => btn.style.display = 'none');
                assistantMicBtn.style.display = 'none';
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript.trim() + ' ';
                }
                
                if (assistantConversation && assistantConversation.isActive()) {
                    assistantConversation.handleResult(transcript.trim());
                } else if (activeSpeechTarget) {
                    activeSpeechTarget.value += transcript;
                }
            };

            recognition.onend = () => {
                isRecognitionRunning = false;
                if (activeSpeechTarget) {
                    const activeBtn = document.querySelector(`.speech-btn[data-target="${activeSpeechTarget.id}"]`);
                    if (activeBtn) activeBtn.classList.remove('listening');
                    activeSpeechTarget = null;
                }
                if (assistantConversation && assistantConversation.isActive()) {
                    assistantMicBtn.classList.remove('listening');
                }
            };
            
            recognition.onstart = () => {
                isRecognitionRunning = true;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                isRecognitionRunning = false;
                if (activeSpeechTarget) {
                     const activeBtn = document.querySelector(`.speech-btn[data-target="${activeSpeechTarget.id}"]`);
                     if (activeBtn) activeBtn.classList.remove('listening');
                     activeSpeechTarget = null;
                }
                 if (assistantConversation && assistantConversation.isActive()) {
                    assistantMicBtn.classList.remove('listening');
                }
            };
        }
        
        function handleAdminAction(action) {
            pendingAdminAction = action;
            loginError.classList.add('hidden');
            loginModal.classList.remove('hidden');
        }

        function executeAdminAction(action) {
            switch(action) {
                case 'add':
                    addAcceleratorModal.dataset.mode = 'add';
                    modalTitle.textContent = 'Cadastrar Novo Acelerador';
                    newAcceleratorName.value = '';
                    newAcceleratorProblem.value = '';
                    newAcceleratorSolution.value = '';
                    document.querySelectorAll('#new-accelerator-products-container input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                    addAcceleratorModal.classList.remove('hidden');
                    break;
                case 'edit':
                     if (!activeAcceleratorKey) return;
                    const template = situacaoTemplates[activeAcceleratorKey];
                    addAcceleratorModal.dataset.mode = 'edit';
                    addAcceleratorModal.dataset.key = activeAcceleratorKey;
                    modalTitle.textContent = 'Editar Acelerador';
                    newAcceleratorName.value = template.nome;
                    newAcceleratorProblem.value = template.problema;
                    newAcceleratorSolution.value = template.solucao;
                    document.querySelectorAll('#new-accelerator-products-container input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = template.associatedProducts.includes(checkbox.value);
                    });
                    addAcceleratorModal.classList.remove('hidden');
                    break;
                case 'delete':
                    if (!activeAcceleratorKey || !activeAcceleratorKey.startsWith('custom_')) return;
                    deleteCustomAccelerator(activeAcceleratorKey);
                    renderAcceleratorButtons();
                    problemaSolucaoSection.classList.add('hidden');
                    editAcceleratorBtn.classList.add('hidden');
                    deleteAcceleratorBtn.classList.add('hidden');
                    activeAcceleratorKey = '';
                    break;
            }
        }

        // --- Voice Assistant Logic ---
        const conversationFlow = [
            { question: "Qual é o nome do solicitante?", target: solicitanteInput, type: 'text' },
            { question: "Qual é o código do cliente?", target: codigoClienteInput, type: 'text' },
            { question: "Qual é o produto do atendimento?", target: produtoSelect, options: produtos, type: 'select' },
            { question: "Qual a origem do atendimento?", target: origemSelect, options: origemOptions, type: 'select' },
            { question: "Qual o humor do cliente?", target: humorContainer, options: humorOptions, type: 'checkbox' },
            { question: "Qual o grau de dificuldade?", target: dificuldadeSelect, options: dificuldadeOptions, type: 'select' },
            { question: "Por favor, descreva o problema do atendimento.", fieldId: "problema_temp", type: 'text_part' },
            { question: "Entendido. Agora, descreva a solução aplicada.", fieldId: "solucao_temp", type: 'text_part' },
            { question: "Obrigado. O preenchimento por voz foi concluído." }
        ];

        class Assistant {
            constructor(flow) {
                this.flow = flow;
                this.currentStep = 0;
                this.active = false;
                this.data = {};
            }
            start() { this.active = true; this.currentStep = 0; this.askQuestion(); }
            stop() { this.active = false; speechSynthesis.cancel(); if (recognition && isRecognitionRunning) recognition.stop(); }
            isActive() { return this.active; }
            askQuestion() {
                if (this.currentStep >= this.flow.length) { this.finish(); return; }
                const step = this.flow[this.currentStep];
                assistantMessage.textContent = step.question;
                userTranscript.textContent = 'Aguardando...';
                const utterance = new SpeechSynthesisUtterance(step.question);
                utterance.lang = 'pt-BR';
                utterance.onend = () => {
                    if (step.target || step.fieldId) {
                        if (recognition && !isRecognitionRunning) recognition.start();
                        assistantMicBtn.classList.add('listening');
                    } else { this.finish(); }
                };
                speechSynthesis.speak(utterance);
            }
            findBestMatch(transcript, options) {
                transcript = transcript.toLowerCase().replace(/[\/\s-]/g, '');
                let bestMatch = null;
                let highestScore = 0;

                options.forEach(option => {
                    const optionId = option.toLowerCase().replace(/[\/\s-]/g, '');
                    let score = 0;
                    if (transcript.includes(optionId)) {
                        score = option.length;
                    } else {
                        const variations = phoneticMap[option] || [];
                        if (variations.some(v => transcript.includes(v))) {
                            score = option.length;
                        }
                    }
                    if (score > highestScore) {
                        highestScore = score;
                        bestMatch = option;
                    }
                });
                return bestMatch;
            }
            findBestMatches(transcript, options) {
                 transcript = transcript.toLowerCase();
                 return options.filter(option => transcript.includes(option.toLowerCase()));
            }
            handleResult(transcript) {
                userTranscript.textContent = `Você disse: "${transcript}"`;
                const step = this.flow[this.currentStep];
                if (!step) return;

                if (step.type === 'select') {
                    const match = this.findBestMatch(transcript, step.options);
                    if (match) {
                        step.target.value = match;
                        step.target.dispatchEvent(new Event('change'));
                    }
                } else if (step.type === 'checkbox') {
                    const matches = this.findBestMatches(transcript, step.options);
                    matches.forEach(match => {
                        const checkbox = document.querySelector(`#humor-container input[value="${match}"]`);
                        if(checkbox) checkbox.checked = true;
                    });
                } else if (step.type === 'text_part') {
                    this.data[step.fieldId] = transcript;
                } else {
                    step.target.value = transcript;
                }
                
                this.currentStep++;
                setTimeout(() => this.askQuestion(), 1200);
            }
            finish() {
                this.stop();
                
                const problema = this.data.problema_temp || '';
                const solucao = this.data.solucao_temp || '';
                descricaoTextarea.value = `Problema: ${problema}\n\nSolução: ${solucao}`;
                situacaoPrincipalSelect.value = 'outro';

                Swal.fire({
                    title: 'Finalizado!',
                    text: 'Contato registrado com sucesso pelo assistente.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false,
                    willClose: () => {
                        assistantSection.classList.add('hidden');
                        document.getElementById('input-section').classList.remove('hidden');
                        toggleAssistantBtn.innerHTML = ` <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15v1a1 1 0 001 1h12a1 1 0 001-1v-1a1 1 0 00-.293-.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg> <span>Assistente de Voz</span>`;
                        generateBtn.click();
                        setTimeout(() => textOutput.scrollIntoView({ behavior: 'smooth' }), 500);
                    }
                });
            }
        }

        // --- Event Listeners ---
        function addEventListeners() {
            document.addEventListener('click', (e) => {
                const speechButton = e.target.closest('.speech-btn');
                if (speechButton && recognition) {
                    const targetId = speechButton.dataset.target;
                    const targetElement = document.getElementById(targetId);

                    if (isRecognitionRunning) {
                        recognition.stop();
                    } 
                    else {
                        activeSpeechTarget = targetElement;
                        recognition.start();
                    }
                }
            });
            
            assistantConversation = new Assistant(conversationFlow);
            
            toggleAssistantBtn.addEventListener('click', () => {
                if (assistantSection.classList.contains('hidden')) {
                    assistantSection.classList.remove('hidden');
                    document.getElementById('input-section').classList.add('hidden');
                    toggleAssistantBtn.innerHTML = ` <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg> <span>Modo Manual</span>`;
                } else {
                    assistantConversation.stop();
                    assistantSection.classList.add('hidden');
                    document.getElementById('input-section').classList.remove('hidden');
                    toggleAssistantBtn.innerHTML = ` <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15v1a1 1 0 001 1h12a1 1 0 001-1v-1a1 1 0 00-.293-.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg> <span>Assistente de Voz</span>`;
                }
            });

            assistantMicBtn.addEventListener('click', () => {
                 if (isRecognitionRunning) {
                    recognition.stop();
                } else {
                    assistantConversation.start();
                }
            });
            
            situacaoPrincipalSelect.addEventListener('change', updateFormDisplay);
            produtoSelect.addEventListener('change', () => {
                updateModulesVisibility();
                renderAcceleratorButtons();
                problemaSolucaoSection.classList.add('hidden');
                editAcceleratorBtn.classList.add('hidden');
                deleteAcceleratorBtn.classList.add('hidden');
            });


            aceleradorButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && button.dataset.key) {
                    handleAcceleratorClick(button.dataset.key);
                }
            });

            generateBtn.addEventListener('click', () => {
                const protocol = generateProtocol();
                if (!protocol) return;

                const finalJson = generateFinalJson(protocol);
                const finalText = generateFinalText(protocol);
                
                textOutput.value = finalText;
                textOutputSection.classList.remove('hidden');

                jsonOutput.textContent = JSON.stringify(finalJson, null, 2);
                jsonOutputSection.classList.remove('hidden');

                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            });

            showAddAcceleratorModalBtn.addEventListener('click', () => handleAdminAction('add'));
            editAcceleratorBtn.addEventListener('click', () => handleAdminAction('edit'));
            deleteAcceleratorBtn.addEventListener('click', () => handleAdminAction('delete'));
            
            cancelLoginBtn.addEventListener('click', () => loginModal.classList.add('hidden'));
            loginBtn.addEventListener('click', () => {
                if (usernameInput.value === 'medware' && passwordInput.value === 'mdw!111096') {
                    loginModal.classList.add('hidden');
                    usernameInput.value = '';
                    passwordInput.value = '';
                    executeAdminAction(pendingAdminAction);
                    pendingAdminAction = null;
                } else {
                    loginError.classList.remove('hidden');
                }
            });


            cancelAddAcceleratorBtn.addEventListener('click', () => {
                addAcceleratorModal.classList.add('hidden');
            });

            saveAcceleratorBtn.addEventListener('click', () => {
                const name = newAcceleratorName.value.trim();
                const problem = newAcceleratorProblem.value;
                const solution = newAcceleratorSolution.value;
                const associatedProducts = Array.from(document.querySelectorAll('#new-accelerator-products-container input:checked')).map(checkbox => checkbox.value);
                const mode = addAcceleratorModal.dataset.mode;
                let key = addAcceleratorModal.dataset.key;

                if (!name || !problem || !solution || associatedProducts.length === 0) {
                    alert('Por favor, preencha todos os campos, incluindo a associação de produtos.');
                    return;
                }
                
                const data = {
                    nome: name,
                    problema: problem,
                    solucao: solution,
                    associatedProducts: associatedProducts
                };

                if (mode === 'add') {
                    key = `custom_${name.toLowerCase().replace(/\s+/g, '_')}_${Date.now()}`;
                }
                
                saveCustomAccelerator(key, name, problem, solution, associatedProducts);
                renderAcceleratorButtons();
                
                if (key === activeAcceleratorKey) {
                    problemaTextarea.value = problem;
                    solucaoTextarea.value = solution;
                }
                
                newAcceleratorName.value = '';
                newAcceleratorProblem.value = '';
                newAcceleratorSolution.value = '';
                addAcceleratorModal.classList.add('hidden');
            });
            
            document.getElementById('template-file').addEventListener('change', (e) => {
                demandTemplateFile = e.target.files[0];
            });

            generateDemandDocBtn.addEventListener('click', () => {
                if (!demandTemplateFile) {
                    alert("Por favor, carregue um arquivo de modelo .docx primeiro.");
                    return;
                }

                const reader = new FileReader();
                reader.onerror = (error) => {
                    console.error("Erro ao ler o arquivo:", error);
                    alert("Não foi possível ler o arquivo de modelo.");
                };
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const zip = new PizZip(content);
                        const doc = new docxtemplater(zip, { paragraphLoop: true, linebreaks: true });

                        const demandData = {
                            solicitacao: document.getElementById('demand-solicitacao').value,
                            nome_clinica: document.getElementById('demand-nome-clinica').value,
                            telefone: document.getElementById('demand-telefone').value,
                            nome_solicitante: document.getElementById('demand-nome-solicitante').value,
                            email: document.getElementById('demand-email').value,
                        };
                        
                        doc.render(demandData);

                        const out = doc.getZip().generate({
                            type: "blob",
                            mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                        });
                        
                        saveAs(out, `demanda_${demandData.nome_clinica.replace(/\s+/g, '_')}.docx`);
                    } catch (error) {
                        console.error("Erro do Docxtemplater:", error);
                        alert("Ocorreu um erro ao gerar o documento. Verifique se os placeholders no seu modelo .docx correspondem exatamente a estes: {solicitacao}, {nome_clinica}, {telefone}, {nome_solicitante}, {email}");
                    }
                };
                reader.readAsArrayBuffer(demandTemplateFile);
            });

            prepareEmailBtn.addEventListener('click', () => {
                const to = "demandas@medware.com.br";
                const cc = `suporte@medware.com.br;${document.getElementById('demand-email').value}`;
                const subject = `Nova Solicitação de Suporte: ${document.getElementById('demand-nome-clinica').value}`;
                const body = "Prezados,\n\nSegue em anexo o documento da demanda.\n\nAtenciosamente.";
                const mailtoLink = `mailto:${to}?cc=${cc}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoLink, '_blank');
            });

            const copyToClipboard = (text, buttonElement) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalContent = buttonElement.innerHTML;
                    buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                    setTimeout(() => { buttonElement.innerHTML = originalContent; }, 2000);
                } catch (err) {
                    console.error('Falha ao copiar texto: ', err);
                }
                document.body.removeChild(textArea);
            };
            
            copyJsonBtn.addEventListener('click', () => copyToClipboard(jsonOutput.textContent, copyJsonBtn));
            copyTextBtn.addEventListener('click', () => copyToClipboard(textOutput.value, copyTextBtn));
        }

        // --- Initialize the App ---
        document.addEventListener('DOMContentLoaded', initializeForm);
    </script>
</body>
</html>
